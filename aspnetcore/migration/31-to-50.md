---
title: 從 ASP.NET Core 3.1 遷移至5。0
author: scottaddie
description: 瞭解如何將 ASP.NET Core 3.1 專案遷移至 ASP.NET Core 5.0。
ms.author: scaddie
ms.custom: mvc
ms.date: 12/02/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: migration/31-to-50
ms.openlocfilehash: 00949acff9908b4a75b6604396876b9c6c41cb3a
ms.sourcegitcommit: 37186f76e4a50d7fb7389026dd0e5e234b51ebb2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/04/2021
ms.locfileid: "99541351"
---
# <a name="migrate-from-aspnet-core-31-to-50"></a><span data-ttu-id="15227-103">從 ASP.NET Core 3.1 遷移至5。0</span><span class="sxs-lookup"><span data-stu-id="15227-103">Migrate from ASP.NET Core 3.1 to 5.0</span></span>

<span data-ttu-id="15227-104">作者：[Scott Addie](https://github.com/scottaddie)</span><span class="sxs-lookup"><span data-stu-id="15227-104">By [Scott Addie](https://github.com/scottaddie)</span></span>

<span data-ttu-id="15227-105">本文說明如何將現有的 ASP.NET Core 3.1 專案更新為 ASP.NET Core 5.0。</span><span class="sxs-lookup"><span data-stu-id="15227-105">This article explains how to update an existing ASP.NET Core 3.1 project to ASP.NET Core 5.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="15227-106">必要條件</span><span class="sxs-lookup"><span data-stu-id="15227-106">Prerequisites</span></span>

# <a name="visual-studio"></a>[<span data-ttu-id="15227-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="15227-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-5.0.md)]

# <a name="visual-studio-code"></a>[<span data-ttu-id="15227-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="15227-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-5.0.md)]

# <a name="visual-studio-for-mac"></a>[<span data-ttu-id="15227-109">Visual Studio for Mac</span><span class="sxs-lookup"><span data-stu-id="15227-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-5.0.md)]

---

## <a name="update-net-core-sdk-version-in-globaljson"></a><span data-ttu-id="15227-110">更新 global.json 中的 .NET Core SDK 版本</span><span class="sxs-lookup"><span data-stu-id="15227-110">Update .NET Core SDK version in global.json</span></span>

<span data-ttu-id="15227-111">如果您依賴檔案 [ 上的global.js](/dotnet/core/tools/global-json) ，以特定的 .NET Core SDK 版本為目標，請將該 `version` 屬性更新為已安裝的 .net 5.0 SDK 版本。</span><span class="sxs-lookup"><span data-stu-id="15227-111">If you rely upon a [global.json](/dotnet/core/tools/global-json) file to target a specific .NET Core SDK version, update the `version` property to the .NET 5.0 SDK version that's installed.</span></span> <span data-ttu-id="15227-112">例如：</span><span class="sxs-lookup"><span data-stu-id="15227-112">For example:</span></span>

```diff
{
  "sdk": {
-    "version": "3.1.200"
+    "version": "5.0.100"
  }
}
```

## <a name="update-the-target-framework"></a><span data-ttu-id="15227-113">更新目標 framework</span><span class="sxs-lookup"><span data-stu-id="15227-113">Update the target framework</span></span>

<span data-ttu-id="15227-114">如果更新 Blazor WebAssembly 專案，請跳至 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 一節。</span><span class="sxs-lookup"><span data-stu-id="15227-114">If updating a Blazor WebAssembly project, skip to the [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) section.</span></span> <span data-ttu-id="15227-115">若為任何其他 ASP.NET Core 專案類型，請將專案檔的 [目標 Framework 標記 (TFM) ](/dotnet/standard/frameworks) 更新為 `net5.0` ：</span><span class="sxs-lookup"><span data-stu-id="15227-115">For any other ASP.NET Core project type, update the project file's [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `net5.0`:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

</Project>
```

## <a name="changes-to-blazor-app-routing-logic-in-501-and-further-5x-releases-up-to-60"></a><span data-ttu-id="15227-116">Blazor5.0.1 中的應用程式路由邏輯變更，以及進一步的5.x 版（最高6.0）</span><span class="sxs-lookup"><span data-stu-id="15227-116">Changes to Blazor app routing logic in 5.0.1 and further 5.x releases up to 6.0</span></span>

<span data-ttu-id="15227-117">在 ASP.NET Core 5.0.1 修補程式版本中，路由優先順序的計算已變更。</span><span class="sxs-lookup"><span data-stu-id="15227-117">The computation of route precedence changed in the ASP.NET Core 5.0.1 patch release.</span></span> <span data-ttu-id="15227-118">如果您已使用選擇性參數定義了全部攔截路由或路由，這可能會對您造成影響。</span><span class="sxs-lookup"><span data-stu-id="15227-118">This might affect you if you've defined catch-all routes or routes with optional parameters.</span></span>

### <a name="old-behavior"></a><span data-ttu-id="15227-119">舊的行為</span><span class="sxs-lookup"><span data-stu-id="15227-119">Old behavior</span></span>

<span data-ttu-id="15227-120">使用 ASP.NET Core 5.0.0 或更早版本中的先前行為時，優先順序較低的路由（例如 `{*slug}` ）會在優先順序較高的路由之前相符，例如 `/customer/{id}` 。</span><span class="sxs-lookup"><span data-stu-id="15227-120">With the prior behavior in ASP.NET Core 5.0.0 or earlier, routes with lower precedence, such as `{*slug}`, are matched before routes with higher precedence, such as `/customer/{id}`.</span></span>

### <a name="new-behavior"></a><span data-ttu-id="15227-121">新的行為</span><span class="sxs-lookup"><span data-stu-id="15227-121">New behavior</span></span>

<span data-ttu-id="15227-122">ASP.NET Core 5.0.1 或更新版本中的新行為，更接近 ASP.NET Core 應用程式中定義的路由行為，其中架構會先計算並建立每個區段的路由優先順序，而且只會使用路由的長度來將系結分隔為次要準則。</span><span class="sxs-lookup"><span data-stu-id="15227-122">The new behavior in ASP.NET Core 5.0.1 or later more closely matches the routing behavior defined in ASP.NET Core apps, where the framework computes and establishes the route precedence for each segment first and only uses the length of the route to break ties as a secondary criteria.</span></span>

### <a name="reason-for-change"></a><span data-ttu-id="15227-123">變更的原因</span><span class="sxs-lookup"><span data-stu-id="15227-123">Reason for change</span></span>

<span data-ttu-id="15227-124">原始行為被視為是執行中的錯誤，因為我們的目標是要讓路由系統的運作方式，與 Blazor 路由所支援的功能子集的 ASP.NET Core 路由系統相同 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="15227-124">The original behavior is considered a bug in the implementation because our goal is for the Blazor routing system to behave in the same way as the ASP.NET Core routing system for the subset of features supported by Blazor routing.</span></span>

### <a name="recommended-action"></a><span data-ttu-id="15227-125">建議的動作</span><span class="sxs-lookup"><span data-stu-id="15227-125">Recommended action</span></span>

<span data-ttu-id="15227-126">將 `PreferExactMatches` 屬性新增至檔案 `Router` 中的元件 `App.razor` ，以加入宣告正確的行為：</span><span class="sxs-lookup"><span data-stu-id="15227-126">Add the `PreferExactMatches` attribute to the `Router` component in the `App.razor` file to opt into the correct behavior:</span></span>

```razor
<Router AppAssembly="@typeof(Program).Assembly" PreferExactMatches="@true">
```

<span data-ttu-id="15227-127">當 `PreferExactMatches` 設定為時 `@true` ，路由比對會優先于萬用字元的完全相符專案。</span><span class="sxs-lookup"><span data-stu-id="15227-127">When `PreferExactMatches` is set to `@true`, route matching prefers exact matches over wildcards.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="15227-128">所有應用程式應明確設定 `PreferExactMatches` 為 `@true` 。</span><span class="sxs-lookup"><span data-stu-id="15227-128">All apps should explicitly set `PreferExactMatches` to `@true`.</span></span>
>
> <span data-ttu-id="15227-129">將設定 `PreferExactMatches` 為或保持未設定狀態的功能 `@false` *，只是為了回溯相容性而提供*。</span><span class="sxs-lookup"><span data-stu-id="15227-129">The ability to set `PreferExactMatches` to `@false` or leave it unset *is only provided for backward compatibility*.</span></span>
>
> <span data-ttu-id="15227-130">當 .NET 6 發行時，路由器一律會偏好完全相符，而且無法 `PreferExactMatches` 使用選項。</span><span class="sxs-lookup"><span data-stu-id="15227-130">When .NET 6 is released, the router will always prefer exact matches, and the `PreferExactMatches` option won't be available.</span></span>

## <a name="update-blazor-webassembly-and-blazor-server-projects"></a><span data-ttu-id="15227-131">更新 Blazor WebAssembly 和 Blazor Server 專案</span><span class="sxs-lookup"><span data-stu-id="15227-131">Update Blazor WebAssembly and Blazor Server projects</span></span>

<span data-ttu-id="15227-132">*本節中的指導方針適用于這兩個 Blazor 裝載模型。本節後面的各節提供裝載模型和應用程式類型的其他相關指引。將所有相關區段中的指引套用至您的應用程式。*</span><span class="sxs-lookup"><span data-stu-id="15227-132">*The guidance in this section applies to both Blazor hosting models. Sections following this section provide additional guidance specific to hosting models and app types. Apply the guidance from all relevant sections to your app.*</span></span>

1. <span data-ttu-id="15227-133">在應用程式 `wwwroot/index.html` Blazor WebAssembly 或 `Pages/_Host.cshtml` 應用程式的中 Blazor Server ，將專案加入 `<link>` 至樣式的 `<head>` 元素中。</span><span class="sxs-lookup"><span data-stu-id="15227-133">In `wwwroot/index.html` of a Blazor WebAssembly app or the `Pages/_Host.cshtml` of a Blazor Server app, add a `<link>` element to the `<head>` element for styles.</span></span> <span data-ttu-id="15227-134">在下列 `<link>` 元素 `href` 屬性值中，預留位置 `{ASSEMBLY NAME}` 是應用程式的元件名稱。</span><span class="sxs-lookup"><span data-stu-id="15227-134">In the following `<link>` element `href` attribute values, the placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

    ```diff
    +<link href="{ASSEMBLY NAME}.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="15227-135">獨立 Blazor WebAssembly 或 Blazor Server 範例：</span><span class="sxs-lookup"><span data-stu-id="15227-135">Standalone Blazor WebAssembly or Blazor Server example:</span></span>

    ```diff
    +<link href="BlazorSample.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="15227-136">*`Client`* 託管 Blazor WebAssembly 解決方案範例的專案：</span><span class="sxs-lookup"><span data-stu-id="15227-136">*`Client`* project of a hosted Blazor WebAssembly solution example:</span></span>

    ```diff
    +<link href="BlazorSample.Client.styles.css" rel="stylesheet" />
    ```

1. <span data-ttu-id="15227-137">在 `_Imports.razor` [元件虛擬化](xref:blazor/components/virtualization)的應用程式檔案中包含新的命名空間 <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName> 。</span><span class="sxs-lookup"><span data-stu-id="15227-137">Include a new namespace in the app's `_Imports.razor` file for [component virtualization](xref:blazor/components/virtualization), <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName>.</span></span> <span data-ttu-id="15227-138">下列檔案 `_Imports.razor` 顯示專案範本所產生之應用程式中的預設命名空間 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="15227-138">The following `_Imports.razor` files show the default namespaces in apps generated from the Blazor project templates.</span></span> <span data-ttu-id="15227-139">預留位置 `{ASSEMBLY NAME}` 是應用程式的元件名稱。</span><span class="sxs-lookup"><span data-stu-id="15227-139">The placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

   <span data-ttu-id="15227-140">Blazor WebAssembly (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="15227-140">Blazor WebAssembly (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using System.Net.Http.Json
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.AspNetCore.Components.WebAssembly.Http
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```

   <span data-ttu-id="15227-141">Blazor Server (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="15227-141">Blazor Server (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using Microsoft.AspNetCore.Authorization
   @using Microsoft.AspNetCore.Components.Authorization
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```
   
1. <span data-ttu-id="15227-142">在 `MainLayout` 元件 (`Shared/MainLayout.razor`) 中，使用 `<div>` `class` 屬性設定為的專案，括住元件的 HTML 標籤 `page` ：</span><span class="sxs-lookup"><span data-stu-id="15227-142">In the `MainLayout` component (`Shared/MainLayout.razor`), surround the component's HTML markup with a `<div>` element that has a `class` attribute set to `page`:</span></span>

    ```razor
    <div class="page">
    
        ...
        
    </div>
    ```
    
1. <span data-ttu-id="15227-143">將下列檔案新增至 `Shared` 資料夾：</span><span class="sxs-lookup"><span data-stu-id="15227-143">Add the following files to the `Shared` folder:</span></span>

    <span data-ttu-id="15227-144">`MainLayout.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="15227-144">`MainLayout.razor.css`:</span></span>
    
    ```css
    .page {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .main {
        flex: 1;
    }

    .sidebar {
        background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
    }

    .top-row {
        background-color: #f7f7f7;
        border-bottom: 1px solid #d6d5d5;
        justify-content: flex-end;
        height: 3.5rem;
        display: flex;
        align-items: center;
    }

        .top-row ::deep a, .top-row .btn-link {
            white-space: nowrap;
            margin-left: 1.5rem;
        }

        .top-row a:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
        }

    @media (max-width: 767.98px) {
        .top-row:not(.auth) {
            display: none;
        }

        .top-row.auth {
            justify-content: space-between;
        }

        .top-row a, .top-row .btn-link {
            margin-left: 0;
        }
    }

    @media (min-width: 768px) {
        .page {
            flex-direction: row;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .top-row {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .main > div {
            padding-left: 2rem !important;
            padding-right: 1.5rem !important;
        }
    }
    ```
    
    <span data-ttu-id="15227-145">`NavMenu.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="15227-145">`NavMenu.razor.css`:</span></span>
    
    ```css
    .navbar-toggler {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .top-row {
        height: 3.5rem;
        background-color: rgba(0,0,0,0.4);
    }

    .navbar-brand {
        font-size: 1.1rem;
    }

    .oi {
        width: 2rem;
        font-size: 1.1rem;
        vertical-align: text-top;
        top: -2px;
    }

    .nav-item {
        font-size: 0.9rem;
        padding-bottom: 0.5rem;
    }

        .nav-item:first-of-type {
            padding-top: 1rem;
        }

        .nav-item:last-of-type {
            padding-bottom: 1rem;
        }

        .nav-item ::deep a {
            color: #d7d7d7;
            border-radius: 4px;
            height: 3rem;
            display: flex;
            align-items: center;
            line-height: 3rem;
        }

    .nav-item ::deep a.active {
        background-color: rgba(255,255,255,0.25);
        color: white;
    }

    .nav-item ::deep a:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }

    @media (min-width: 768px) {
        .navbar-toggler {
            display: none;
        }

        .collapse {
            /* Never collapse the sidebar for wide screens */
            display: block;
        }
    }
    ```

1. <span data-ttu-id="15227-146">應用程式或應用程式檔案的最新基底檔案 `wwwroot/css/app.css` Blazor WebAssembly `wwwroot/css/site.css` Blazor Server 包含下列樣式。</span><span class="sxs-lookup"><span data-stu-id="15227-146">The latest base `wwwroot/css/app.css` file of a Blazor WebAssembly app or `wwwroot/css/site.css` file of a Blazor Server app includes the following styles.</span></span> <span data-ttu-id="15227-147">移除額外的樣式，並保留下列樣式以及您已新增至應用程式的任何樣式。</span><span class="sxs-lookup"><span data-stu-id="15227-147">Remove extra styles leaving the following styles and any that you've added to the app.</span></span>

    <span data-ttu-id="15227-148">下列樣式表單只包含基底樣式，而且 **不包含開發** 人員新增的自訂樣式：</span><span class="sxs-lookup"><span data-stu-id="15227-148">The following stylesheet only includes base styles and does **not** include custom styles added by the developer:</span></span>
   
    ```css
    @import url('open-iconic/font/css/open-iconic-bootstrap.min.css');

    html, body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    a, .btn-link {
        color: #0366d6;
    }

    .btn-primary {
        color: #fff;
        background-color: #1b6ec2;
        border-color: #1861ac;
    }

    .content {
        padding-top: 1.1rem;
    }

    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    ```

## <a name="update-blazor-webassembly-projects"></a><span data-ttu-id="15227-149">更新 Blazor WebAssembly 專案</span><span class="sxs-lookup"><span data-stu-id="15227-149">Update Blazor WebAssembly projects</span></span>

<span data-ttu-id="15227-150">遵循先前的 [更新 Blazor WebAssembly 和 Blazor Server 專案](#update-blazor-webassembly-and-blazor-server-projects) 一節中的指導方針。</span><span class="sxs-lookup"><span data-stu-id="15227-150">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) section.</span></span>

<span data-ttu-id="15227-151">針對 Blazor WebAssembly 專案（包括 *`Client`* 主控方案的專案 Blazor ），將下列變更套用至專案檔：</span><span class="sxs-lookup"><span data-stu-id="15227-151">For a Blazor WebAssembly project, including the *`Client`* project of a hosted Blazor solution, apply the following changes to the project file:</span></span>

1. <span data-ttu-id="15227-152">將 SDK 從更新 `Microsoft.NET.Sdk.Web` 為 `Microsoft.NET.Sdk.BlazorWebAssembly` ：</span><span class="sxs-lookup"><span data-stu-id="15227-152">Update the SDK from `Microsoft.NET.Sdk.Web` to `Microsoft.NET.Sdk.BlazorWebAssembly`:</span></span>

    ```diff
    - <Project Sdk="Microsoft.NET.Sdk.Web">
    + <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    ```
    
    > [!NOTE]
    > <span data-ttu-id="15227-153">此更新僅適用于獨立 Blazor WebAssembly 專案和裝載 *`Client`* 解決方案的專案 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="15227-153">This update only applies to standalone Blazor WebAssembly projects and the *`Client`* projects of hosted Blazor solutions.</span></span>

1. <span data-ttu-id="15227-154">更新下列屬性：</span><span class="sxs-lookup"><span data-stu-id="15227-154">Update the following properties:</span></span>

    ```diff
    <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    
      <PropertyGroup>
    -     <TargetFramework>netstandard2.1</TargetFramework>
    -     <RazorLangVersion>3.0</RazorLangVersion>
    +     <TargetFramework>net5.0</TargetFramework>
      </PropertyGroup>
    ```

1. <span data-ttu-id="15227-155">移除 WebAssembly 的套件參考。 [建立 AspNetCore](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build)：</span><span class="sxs-lookup"><span data-stu-id="15227-155">Remove the package reference to [Microsoft.AspNetCore.Components.WebAssembly.Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span></span>

    ```diff
    <ItemGroup>
    -    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Build" Version="3.2.1" PrivateAssets="all" />
    ```

1. <span data-ttu-id="15227-156">將其他套件更新至其最新版本。</span><span class="sxs-lookup"><span data-stu-id="15227-156">Update other packages to their latest versions.</span></span> <span data-ttu-id="15227-157">您可以在 [NuGet.org](https://www.nuget.org)找到最新版本。</span><span class="sxs-lookup"><span data-stu-id="15227-157">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

1. <span data-ttu-id="15227-158">在中 `wwwroot/index.html` ，將載入元件的元素變更為專案， `App` `<div>` 其 `id` 設定為 `app` ：</span><span class="sxs-lookup"><span data-stu-id="15227-158">In `wwwroot/index.html`, change the element that loads the `App` component to a `<div>` element with an `id` set to `app`:</span></span>
    
    ```diff
    -<app>Loading...</app>
    +<div id="app">Loading...</div>
    ```

1. <span data-ttu-id="15227-159">在 `Program.Main` (`Program.cs`) 中，藉 `<app>` 由在其中新增雜湊來將專案的參考變更為 CSS 選取器 `#` ：</span><span class="sxs-lookup"><span data-stu-id="15227-159">In `Program.Main` (`Program.cs`), change the reference to the `<app>` element to a CSS selector by adding a hash `#` to it:</span></span>

    ```diff
    -builder.RootComponents.Add<App>("app");
    +builder.RootComponents.Add<App>("#app");
    ```

1. <span data-ttu-id="15227-160">在 `Program.Main` (`Program.cs`) 中，將預設的暫時性註冊變更為已設定 `HttpClient` 範圍的範圍（如果有的話）：</span><span class="sxs-lookup"><span data-stu-id="15227-160">In `Program.Main` (`Program.cs`), change a default transient `HttpClient` registration to scoped, if present:</span></span>

   ```diff
   -builder.Services.AddTransient(sp => new HttpClient 
   -    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
   +builder.Services.AddScoped(sp => new HttpClient 
   +    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
   ```

1. <span data-ttu-id="15227-161">在 `Program.Main` (的 `Program.cs` **`Client`** 託管解決方案應用程式) 中 Blazor ：</span><span class="sxs-lookup"><span data-stu-id="15227-161">In `Program.Main` (`Program.cs`) of the **`Client`** app of hosted Blazor solutions:</span></span>
    
   * <span data-ttu-id="15227-162">（選擇性）替代 `builder.HostEnvironment.BaseAddress` 字串用戶端基底位址。</span><span class="sxs-lookup"><span data-stu-id="15227-162">Optionally, substitute `builder.HostEnvironment.BaseAddress` for string client base addresses.</span></span>
   * <span data-ttu-id="15227-163">將任何已命名的暫時性用戶端 factory 註冊變更為限域。</span><span class="sxs-lookup"><span data-stu-id="15227-163">Change any named transient client factory registrations to scoped.</span></span>

   ```diff
   -builder.Services.AddHttpClient("{APP NAMESPACE}.ServerAPI", 
   -    client => client.BaseAddress = new Uri("https://localhost:5001"))
   -    .AddHttpMessageHandler<BaseAddressAuthorizationMessageHandler>();
   -builder.Services.AddTransient(sp => sp.GetRequiredService<IHttpClientFactory>()
   -    .CreateClient("{APP NAMESPACE}.ServerAPI"));
   +builder.Services.AddHttpClient("{APP NAMESPACE}.ServerAPI", 
   +    client => client.BaseAddress = new Uri(builder.HostEnvironment.BaseAddress))
   +    .AddHttpMessageHandler<BaseAddressAuthorizationMessageHandler>();
   +builder.Services.AddScoped(sp => sp.GetRequiredService<IHttpClientFactory>()
   +    .CreateClient("{APP NAMESPACE}.ServerAPI"));
    ```
    
   <span data-ttu-id="15227-164">在上述程式碼中， `{APP NAMESPACE}` 預留位置是應用程式的命名空間。</span><span class="sxs-lookup"><span data-stu-id="15227-164">In the preceding code, the `{APP NAMESPACE}` placeholder is the app's namespace.</span></span>

### <a name="standalone-blazor-webassembly-app-with-microsoft-accounts"></a><span data-ttu-id="15227-165">Blazor WebAssembly使用 Microsoft 帳戶的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-165">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>

<span data-ttu-id="15227-166">遵循先前的 [更新 Blazor WebAssembly 和 Blazor Server 專案](#update-blazor-webassembly-and-blazor-server-projects) 和 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 小節中的指導方針。</span><span class="sxs-lookup"><span data-stu-id="15227-166">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="15227-167">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用適用于 Microsoft 帳戶的 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="15227-167">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) for Microsoft Accounts:</span></span>

* <span data-ttu-id="15227-168">應用程式需要 `openid` 和 `offline_access` 範圍：</span><span class="sxs-lookup"><span data-stu-id="15227-168">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="15227-169">在 [Azure 入口網站應用程式註冊 **驗證** ] 分頁中：</span><span class="sxs-lookup"><span data-stu-id="15227-169">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="15227-170">移除 **Web** platform configuration。</span><span class="sxs-lookup"><span data-stu-id="15227-170">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="15227-171">使用應用程式的重新導向 URI 新增 **單一頁面應用程式** 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="15227-171">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="15227-172">停用 **存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="15227-172">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="15227-173">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-microsoft-accounts>。</span><span class="sxs-lookup"><span data-stu-id="15227-173">For more information, see <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span></span>

### <a name="standalone-blazor-webassembly-app-with-azure-active-directory-aad"></a><span data-ttu-id="15227-174">Blazor WebAssembly具有 Azure Active Directory (AAD) 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-174">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>

<span data-ttu-id="15227-175">遵循先前的 [更新 Blazor WebAssembly 和 Blazor Server 專案](#update-blazor-webassembly-and-blazor-server-projects) 和 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 小節中的指導方針。</span><span class="sxs-lookup"><span data-stu-id="15227-175">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="15227-176">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="15227-176">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD):</span></span>

* <span data-ttu-id="15227-177">應用程式需要 `https://graph.microsoft.com/User.Read` 範圍：</span><span class="sxs-lookup"><span data-stu-id="15227-177">The app requires the `https://graph.microsoft.com/User.Read` scope:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes
      .Add("https://graph.microsoft.com/User.Read");
  ```
  
* <span data-ttu-id="15227-178">在 [Azure 入口網站應用程式註冊 **驗證** ] 分頁中：</span><span class="sxs-lookup"><span data-stu-id="15227-178">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="15227-179">移除 **Web** platform configuration。</span><span class="sxs-lookup"><span data-stu-id="15227-179">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="15227-180">使用應用程式的重新導向 URI 新增 **單一頁面應用程式** 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="15227-180">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="15227-181">停用 **存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="15227-181">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>
  
<span data-ttu-id="15227-182">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-azure-active-directory>。</span><span class="sxs-lookup"><span data-stu-id="15227-182">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span></span>

### <a name="standalone-blazor-webassembly-app-with-azure-active-directory-aad-b2c"></a><span data-ttu-id="15227-183">Blazor WebAssembly使用 Azure Active Directory (AAD) B2C 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-183">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>

<span data-ttu-id="15227-184">遵循先前的 [更新 Blazor WebAssembly 和 Blazor Server 專案](#update-blazor-webassembly-and-blazor-server-projects) 和 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 小節中的指導方針。</span><span class="sxs-lookup"><span data-stu-id="15227-184">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="15227-185">針對 Blazor WebAssembly 在 Azure 入口網站中註冊的獨立應用程式，以使用 Azure Active Directory (AAD) B2C：</span><span class="sxs-lookup"><span data-stu-id="15227-185">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) B2C:</span></span>

* <span data-ttu-id="15227-186">應用程式需要 `openid` 和 `offline_access` 範圍：</span><span class="sxs-lookup"><span data-stu-id="15227-186">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="15227-187">在 [Azure 入口網站應用程式註冊 **驗證** ] 分頁中：</span><span class="sxs-lookup"><span data-stu-id="15227-187">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="15227-188">移除 **Web** platform configuration。</span><span class="sxs-lookup"><span data-stu-id="15227-188">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="15227-189">使用應用程式的重新導向 URI 新增 **單一頁面應用程式** 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="15227-189">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="15227-190">停用 **存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="15227-190">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="15227-191">如需詳細資訊，請參閱<xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>。</span><span class="sxs-lookup"><span data-stu-id="15227-191">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span></span>

### <a name="hosted-blazor-webassembly-app-with-azure-active-directory-aad-or-aad-b2c"></a><span data-ttu-id="15227-192">Blazor WebAssembly具有 Azure Active Directory (AAD) 或 AAD B2C 的託管應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-192">Hosted Blazor WebAssembly app with Azure Active Directory (AAD) or AAD B2C</span></span>

<span data-ttu-id="15227-193">遵循先前的 [更新 Blazor WebAssembly 和 Blazor Server 專案](#update-blazor-webassembly-and-blazor-server-projects) 和 [更新 Blazor WebAssembly 專案](#update-blazor-webassembly-projects) 小節中的指導方針。</span><span class="sxs-lookup"><span data-stu-id="15227-193">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="15227-194">*`Client`* Blazor 使用 AAD 或 AAD B2C 進行使用者驗證之託管解決方案的應用程式註冊，應使用 **單一頁面應用程式** Azure Apps 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="15227-194">The *`Client`* app registration of a hosted Blazor solution that uses AAD or AAD B2C for user authentication should use a **Single-page application** Azure Apps platform configuration.</span></span>

<span data-ttu-id="15227-195">在 [Azure 入口網站 *`Client`* 應用程式註冊 **驗證** ] 分頁中：</span><span class="sxs-lookup"><span data-stu-id="15227-195">In the Azure portal *`Client`* app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="15227-196">移除 **Web** platform configuration。</span><span class="sxs-lookup"><span data-stu-id="15227-196">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="15227-197">使用應用程式的重新導向 URI 新增 **單一頁面應用程式** 平臺設定。</span><span class="sxs-lookup"><span data-stu-id="15227-197">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="15227-198">停用 **存取權杖** 和 **識別碼權杖** 的 **隱含授** 與。</span><span class="sxs-lookup"><span data-stu-id="15227-198">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="15227-199">如需詳細資訊，請參閱</span><span class="sxs-lookup"><span data-stu-id="15227-199">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="update-the-server-project-of-a-hosted-blazor-solution"></a><span data-ttu-id="15227-200">更新主控方案的伺服器專案 Blazor</span><span class="sxs-lookup"><span data-stu-id="15227-200">Update the Server project of a hosted Blazor solution</span></span>

<span data-ttu-id="15227-201">遵循上述各節中的指導方針：</span><span class="sxs-lookup"><span data-stu-id="15227-201">Follow the guidance in the preceding sections:</span></span>

* [<span data-ttu-id="15227-202">更新 Blazor WebAssembly 和 Blazor Server 專案</span><span class="sxs-lookup"><span data-stu-id="15227-202">Update Blazor WebAssembly and Blazor Server projects</span></span>](#update-blazor-webassembly-and-blazor-server-projects)
* [<span data-ttu-id="15227-203">更新 Blazor WebAssembly 專案</span><span class="sxs-lookup"><span data-stu-id="15227-203">Update Blazor WebAssembly projects</span></span>](#update-blazor-webassembly-projects)
* <span data-ttu-id="15227-204">適用于應用程式提供者 Azure Active Directory 的區段：</span><span class="sxs-lookup"><span data-stu-id="15227-204">The section that applies to the app's provider with Azure Active Directory:</span></span>
  * [<span data-ttu-id="15227-205">Blazor WebAssembly使用 Microsoft 帳戶的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-205">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>](#standalone-blazor-webassembly-app-with-microsoft-accounts)
  * [<span data-ttu-id="15227-206">Blazor WebAssembly具有 Azure Active Directory (AAD) 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-206">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad)
  * [<span data-ttu-id="15227-207">Blazor WebAssembly使用 Azure Active Directory (AAD) B2C 的獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="15227-207">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad-b2c)

<span data-ttu-id="15227-208">遵循本文 *`Server`* 中的一般指引，將託管解決方案的專案更新 Blazor 為 ASP.NET Core 應用程式。</span><span class="sxs-lookup"><span data-stu-id="15227-208">Update the *`Server`* project of a hosted Blazor solution as an ASP.NET Core app following the general guidance in this article.</span></span>

<span data-ttu-id="15227-209">此外， *`Server`* Blazor WebAssembly 使用 AZURE ACTIVE DIRECTORY (AAD) 或 B2C 向用戶端應用程式驗證使用者的專案應該採用新的 Microsoft v2.0 Identity 套件：</span><span class="sxs-lookup"><span data-stu-id="15227-209">Additionally, *`Server`* projects that authenticate users to client Blazor WebAssembly apps with Azure Active Directory (AAD) or B2C should adopt new Microsoft Identity v2.0 packages:</span></span> 
  
<span data-ttu-id="15227-210">針對 AAD：</span><span class="sxs-lookup"><span data-stu-id="15227-210">For AAD:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="15227-211">針對 AAD B2C：</span><span class="sxs-lookup"><span data-stu-id="15227-211">For AAD B2C:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureADB2C.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="15227-212">針對上述的套件參考，請 `{VERSION}` 在 NuGet.org 上判斷預留位置的套件版本：</span><span class="sxs-lookup"><span data-stu-id="15227-212">For the preceding package references, determine the package versions for the `{VERSION}` placeholders at NuGet.org:</span></span>

* [`Microsoft.Identity.Web`](https://www.nuget.org/packages/Microsoft.Identity.Web)
* [`Microsoft.Identity.Web.UI`](https://www.nuget.org/packages/Microsoft.Identity.Web.UI)

> [!NOTE]
> <span data-ttu-id="15227-213">裝載 *`Server`* 解決方案中專案的 SDK 會 Blazor WebAssembly 保持 `Microsoft.NET.Sdk.Web` ：</span><span class="sxs-lookup"><span data-stu-id="15227-213">The SDK of the *`Server`* project in a hosted Blazor WebAssembly solution remains `Microsoft.NET.Sdk.Web`:</span></span>
>
> ```xml
> <Project Sdk="Microsoft.NET.Sdk.Web">
> ```

<span data-ttu-id="15227-214">如需詳細資訊，請參閱</span><span class="sxs-lookup"><span data-stu-id="15227-214">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="clean-and-rebuild-the-solution"></a><span data-ttu-id="15227-215">清除並重建解決方案</span><span class="sxs-lookup"><span data-stu-id="15227-215">Clean and rebuild the solution</span></span>

<span data-ttu-id="15227-216">將應用程式或解決方案遷移至 .NET 5 之後，請清除並重建應用程式或解決方案。</span><span class="sxs-lookup"><span data-stu-id="15227-216">After migrating the app or solution to .NET 5, clean and rebuild the app or solution.</span></span> <span data-ttu-id="15227-217">如果新的封裝參考與快取套件之間有套件不相容性：</span><span class="sxs-lookup"><span data-stu-id="15227-217">If package incompatibilities exist between new package references and cached packages:</span></span>

1. <span data-ttu-id="15227-218">在命令 shell 中執行下列命令，以清除 NuGet 套件快取 [`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals) ：</span><span class="sxs-lookup"><span data-stu-id="15227-218">Clear NuGet package caches by executing the following [`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals) command in a command shell:</span></span>

   ```dotnetcli
   dotnet nuget locals --clear all
   ```
   
1. <span data-ttu-id="15227-219">清除並重建應用程式或解決方案。</span><span class="sxs-lookup"><span data-stu-id="15227-219">Clean and rebuild the app or solution.</span></span>

### <a name="troubleshoot"></a><span data-ttu-id="15227-220">疑難排解</span><span class="sxs-lookup"><span data-stu-id="15227-220">Troubleshoot</span></span>

<span data-ttu-id="15227-221">遵循適用于您應用程式之安全性主題結尾處的 *疑難排解* 指導方針 Blazor WebAssembly ：</span><span class="sxs-lookup"><span data-stu-id="15227-221">Follow the *Troubleshoot* guidance at the end of the Blazor WebAssembly security topic that applies to your app:</span></span>

<span data-ttu-id="15227-222">獨立 Blazor WebAssembly 應用程式：</span><span class="sxs-lookup"><span data-stu-id="15227-222">Standalone Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="15227-223">OIDC 提供者和 WebAssembly Authentication Library 的一般指引</span><span class="sxs-lookup"><span data-stu-id="15227-223">General guidance for OIDC providers and the WebAssembly Authentication Library</span></span>](xref:blazor/security/webassembly/standalone-with-authentication-library)
* [<span data-ttu-id="15227-224">Microsoft 帳戶</span><span class="sxs-lookup"><span data-stu-id="15227-224">Microsoft Accounts</span></span>](xref:blazor/security/webassembly/standalone-with-microsoft-accounts)
* [<span data-ttu-id="15227-225">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="15227-225">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory)
* [<span data-ttu-id="15227-226">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="15227-226">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c)

<span data-ttu-id="15227-227">託管 Blazor WebAssembly 應用程式：</span><span class="sxs-lookup"><span data-stu-id="15227-227">Hosted Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="15227-228">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="15227-228">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory)
* [<span data-ttu-id="15227-229">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="15227-229">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c)
* [<span data-ttu-id="15227-230">Identity 伺服器</span><span class="sxs-lookup"><span data-stu-id="15227-230">Identity Server</span></span>](xref:blazor/security/webassembly/hosted-with-identity-server)

### <a name="unauthorized-client-for-azure-active-directory-aad"></a><span data-ttu-id="15227-231">Azure Active Directory (AAD) 的未經授權用戶端</span><span class="sxs-lookup"><span data-stu-id="15227-231">Unauthorized client for Azure Active Directory (AAD)</span></span>

<span data-ttu-id="15227-232">升級 Blazor WebAssembly 使用 aad 進行驗證的應用程式之後，您可能會在使用者使用 aad 登入後，在登入回呼上收到下列錯誤：</span><span class="sxs-lookup"><span data-stu-id="15227-232">After upgrading a Blazor WebAssembly app that uses AAD for authentication, you may receive the following error on the login callback to the app after the user signs in with AAD:</span></span>

> <span data-ttu-id="15227-233">資訊： AspNetCore。 DefaultAuthorizationService [2] 授權失敗。</span><span class="sxs-lookup"><span data-stu-id="15227-233">info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] Authorization failed.</span></span> <span data-ttu-id="15227-234">不符合這些需求： DenyAnonymousAuthorizationRequirement：需要經過驗證的使用者。</span><span class="sxs-lookup"><span data-stu-id="15227-234">These requirements were not met: DenyAnonymousAuthorizationRequirement: Requires an authenticated user.</span></span>

<span data-ttu-id="15227-235">來自 AAD 的登入回呼錯誤：</span><span class="sxs-lookup"><span data-stu-id="15227-235">Login callback error from AAD:</span></span>

* <span data-ttu-id="15227-236">錯誤：`unauthorized_client`</span><span class="sxs-lookup"><span data-stu-id="15227-236">Error: `unauthorized_client`</span></span>
* <span data-ttu-id="15227-237">說明：`AADB2C90058: The provided application is not configured to allow public clients.`</span><span class="sxs-lookup"><span data-stu-id="15227-237">Description: `AADB2C90058: The provided application is not configured to allow public clients.`</span></span>

<span data-ttu-id="15227-238">若要解決此錯誤：</span><span class="sxs-lookup"><span data-stu-id="15227-238">To resolve the error:</span></span>

1. <span data-ttu-id="15227-239">在 Azure 入口網站中，存取 [應用程式的資訊清單](/azure/active-directory/develop/reference-app-manifest)。</span><span class="sxs-lookup"><span data-stu-id="15227-239">In the Azure portal, access the [app's manifest](/azure/active-directory/develop/reference-app-manifest).</span></span>
1. <span data-ttu-id="15227-240">將 [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) 屬性設為 `null` 或 `true` 。</span><span class="sxs-lookup"><span data-stu-id="15227-240">Set the [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) attribute to `null` or `true`.</span></span>

## <a name="update-a-blazor-progressive-web-application-pwa"></a><span data-ttu-id="15227-241">更新 Blazor (PWA 的漸進式 Web 應用程式) </span><span class="sxs-lookup"><span data-stu-id="15227-241">Update a Blazor Progressive Web Application (PWA)</span></span>

<span data-ttu-id="15227-242">將下列專案新增至 PWA 應用程式的專案檔案：</span><span class="sxs-lookup"><span data-stu-id="15227-242">Add the following item to the PWA app's project file:</span></span>

```xml
<ItemGroup>
  <ServiceWorker Include="wwwroot\service-worker.js" 
    PublishedContent="wwwroot\service-worker.published.js" />
</ItemGroup>
```

## <a name="update-razor-class-libraries-rcls"></a><span data-ttu-id="15227-243">更新 Razor 類別庫 (RCLs) </span><span class="sxs-lookup"><span data-stu-id="15227-243">Update Razor class libraries (RCLs)</span></span>

<span data-ttu-id="15227-244">Razor (RCLs) 遷移類別庫，以利用 ASP.NET Core 5.0 中引進的新 api 或功能。</span><span class="sxs-lookup"><span data-stu-id="15227-244">Migrate Razor class libraries (RCLs) to take advantage of new APIs or features that are introduced as part of ASP.NET Core 5.0.</span></span> 

<span data-ttu-id="15227-245">更新以元件為目標的 RCL：</span><span class="sxs-lookup"><span data-stu-id="15227-245">To update a RCL that targets components:</span></span>

1. <span data-ttu-id="15227-246">更新專案檔中的下列屬性：</span><span class="sxs-lookup"><span data-stu-id="15227-246">Update the following properties in the project file:</span></span>

   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Razor">
    
     <PropertyGroup>
   -     <TargetFramework>netstandard2.0</TargetFramework>
   -     <RazorLangVersion>3.0</RazorLangVersion>
   +     <TargetFramework>net5.0</TargetFramework>
     </PropertyGroup>
   ```

1. <span data-ttu-id="15227-247">將其他套件更新至其最新版本。</span><span class="sxs-lookup"><span data-stu-id="15227-247">Update other packages to their latest versions.</span></span> <span data-ttu-id="15227-248">您可以在 [NuGet.org](https://www.nuget.org)找到最新版本。</span><span class="sxs-lookup"><span data-stu-id="15227-248">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

<span data-ttu-id="15227-249">若要更新以 MVC 為目標的 RCL，請更新專案檔中的下列屬性：</span><span class="sxs-lookup"><span data-stu-id="15227-249">To update an RCL targeting MVC, update the following properties in the project file:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Razor">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  </PropertyGroup>
```

## <a name="update-package-references"></a><span data-ttu-id="15227-250">更新套件參考</span><span class="sxs-lookup"><span data-stu-id="15227-250">Update package references</span></span>

<span data-ttu-id="15227-251">在專案檔中，更新每個 [AspNetCore. \*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*)、 [microsoft.entityframeworkcore.](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*)\*、 [，然後](https://www.nuget.org/packages?q=Microsoft.Extensions.*)將封裝參考的屬性上的 [System.Net.Http.Js](https://www.nuget.org/packages/System.Net.Http.Json) 更新 `Version` 為5.0.0 或更新版本。</span><span class="sxs-lookup"><span data-stu-id="15227-251">In the project file, update each [Microsoft.AspNetCore.\*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft.EntityFrameworkCore.\*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft.Extensions.\*](https://www.nuget.org/packages?q=Microsoft.Extensions.*), and [System.Net.Http.Json](https://www.nuget.org/packages/System.Net.Http.Json) package reference's `Version` attribute to 5.0.0 or later.</span></span> <span data-ttu-id="15227-252">例如：</span><span class="sxs-lookup"><span data-stu-id="15227-252">For example:</span></span>

```diff
<ItemGroup>
-    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="3.1.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.6">
-    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="3.1.6" />
-    <PackageReference Include="System.Net.Http.Json" Version="3.2.1" />
+    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="5.0.0" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.0">
+    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="5.0.0" />
+    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
</ItemGroup>
```

## <a name="update-docker-images"></a><span data-ttu-id="15227-253">更新 Docker 映射</span><span class="sxs-lookup"><span data-stu-id="15227-253">Update Docker images</span></span>

<span data-ttu-id="15227-254">若為使用 Docker 的應用程式，請更新您的 *Dockerfile* `FROM` 語句和腳本。</span><span class="sxs-lookup"><span data-stu-id="15227-254">For apps using Docker, update your *Dockerfile* `FROM` statements and scripts.</span></span> <span data-ttu-id="15227-255">使用包含 ASP.NET Core 5.0 執行時間的基底映射。</span><span class="sxs-lookup"><span data-stu-id="15227-255">Use a base image that includes the ASP.NET Core 5.0 runtime.</span></span> <span data-ttu-id="15227-256">請考慮下列 `docker pull` ASP.NET Core 3.1 和5.0 之間的命令差異：</span><span class="sxs-lookup"><span data-stu-id="15227-256">Consider the following `docker pull` command difference between ASP.NET Core 3.1 and 5.0:</span></span>

```diff
- docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1
+ docker pull mcr.microsoft.com/dotnet/aspnet:5.0
```

<span data-ttu-id="15227-257">在移至 ".NET" 作為產品名稱的過程中，會將 Docker 映射從 `mcr.microsoft.com/dotnet/core` 存放庫移至 `mcr.microsoft.com/dotnet` 。</span><span class="sxs-lookup"><span data-stu-id="15227-257">As part of the move to ".NET" as the product name, the Docker images moved from the `mcr.microsoft.com/dotnet/core` repositories to `mcr.microsoft.com/dotnet`.</span></span> <span data-ttu-id="15227-258">如需詳細資訊，請參閱 [dotnet/dotnet-docker # 1939](https://github.com/dotnet/dotnet-docker/issues/1939)。</span><span class="sxs-lookup"><span data-stu-id="15227-258">For more information, see [dotnet/dotnet-docker#1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span></span>

## <a name="model-binding-changes-in-aspnet-core-mvc-and-razor-pages"></a><span data-ttu-id="15227-259">ASP.NET Core MVC 和頁面中的模型系結變更 Razor</span><span class="sxs-lookup"><span data-stu-id="15227-259">Model binding changes in ASP.NET Core MVC and Razor Pages</span></span>

### <a name="datetime-values-are-model-bound-as-utc-times"></a><span data-ttu-id="15227-260">日期時間值是以 UTC 時間系結的模型</span><span class="sxs-lookup"><span data-stu-id="15227-260">DateTime values are model bound as UTC times</span></span>

<span data-ttu-id="15227-261">在 ASP.NET Core 3.1 及更早版本中， `DateTime` 值是以模型系結為本地時間，其中的時區是由伺服器決定。</span><span class="sxs-lookup"><span data-stu-id="15227-261">In ASP.NET Core 3.1 and earlier, `DateTime` values were model-bound as local time, where the timezone was determined by the server.</span></span> <span data-ttu-id="15227-262">`DateTime` 從輸入格式系結的值 (JSON) 和 `DateTimeOffset` 值都系結為 UTC 時區。</span><span class="sxs-lookup"><span data-stu-id="15227-262">`DateTime` values bound from input formatting (JSON) and `DateTimeOffset` values were bound as UTC timezones.</span></span>

<span data-ttu-id="15227-263">在 ASP.NET Core 5.0 和更新版本中，模型系結會以 UTC 時區一致地系結 `DateTime` 值。</span><span class="sxs-lookup"><span data-stu-id="15227-263">In ASP.NET Core 5.0 and later, model binding consistently binds `DateTime` values with the UTC timezone.</span></span>

<span data-ttu-id="15227-264">若要保留先前的行為，請移除 `DateTimeModelBinderProvider` 中的 `Startup.ConfigureServices` ：</span><span class="sxs-lookup"><span data-stu-id="15227-264">To retain the previous behavior, remove the `DateTimeModelBinderProvider` in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddControllersWithViews(options => 
    options.ModelBinderProviders.RemoveType<DateTimeModelBinderProvider>());
```

### <a name="complexobjectmodelbinderprovider--complexobjectmodelbinder-replace-complextypemodelbinderprovider--complextypemodelbinder"></a><span data-ttu-id="15227-265">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span><span class="sxs-lookup"><span data-stu-id="15227-265">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span></span>

<span data-ttu-id="15227-266">若要加入模型系結 [c # 9 記錄類型](/dotnet/csharp/whats-new/csharp-9#record-types)的支援，則 <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> 為：</span><span class="sxs-lookup"><span data-stu-id="15227-266">To add support for model binding [C# 9 record types](/dotnet/csharp/whats-new/csharp-9#record-types), the <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> is:</span></span>

* <span data-ttu-id="15227-267">標注為過時。</span><span class="sxs-lookup"><span data-stu-id="15227-267">Annotated as obsolete.</span></span>
* <span data-ttu-id="15227-268">預設不會再註冊。</span><span class="sxs-lookup"><span data-stu-id="15227-268">No longer registered by default.</span></span>

<span data-ttu-id="15227-269">相依于存在於集合中的應用程式 `ComplexTypeModelBinderProvider` `ModelBinderProviders` 需要參考新的系結器提供者：</span><span class="sxs-lookup"><span data-stu-id="15227-269">Apps that rely on the presence of the `ComplexTypeModelBinderProvider` in the `ModelBinderProviders` collection need to reference the new binder provider:</span></span>

```diff
- var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexTypeModelBinderProvider>();
+ var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexObjectModelBinderProvider>();
```

## <a name="usedatabaseerrorpage-obsolete"></a><span data-ttu-id="15227-270">UseDatabaseErrorPage 已淘汰</span><span class="sxs-lookup"><span data-stu-id="15227-270">UseDatabaseErrorPage obsolete</span></span>

<span data-ttu-id="15227-271">包含個別使用者帳戶選項的 ASP.NET Core 3.1 範本會產生的呼叫 <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A> 。</span><span class="sxs-lookup"><span data-stu-id="15227-271">The ASP.NET Core 3.1 templates that include an option for individual user accounts generate a call to <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A>.</span></span> <span data-ttu-id="15227-272">`UseDatabaseErrorPage` 現在已過時，而且應該以和的組合取代 `AddDatabaseDeveloperPageExceptionFilter` `UseMigrationsEndPoint` ，如下列程式碼所示：</span><span class="sxs-lookup"><span data-stu-id="15227-272">`UseDatabaseErrorPage` is now obsolete and should be replaced with a combination of `AddDatabaseDeveloperPageExceptionFilter` and `UseMigrationsEndPoint`, as shown in the following code:</span></span>

```diff
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));
+   services.AddDatabaseDeveloperPageExceptionFilter();
    services.AddDefaultIdentity<IdentityUser>(options => options.SignIn.RequireConfirmedAccount = true)
        .AddEntityFrameworkStores<ApplicationDbContext>();
    services.AddRazorPages();
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
+       app.UseMigrationsEndPoint();
-       app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }
```

<span data-ttu-id="15227-273">如需詳細資訊，請參閱 [此 GitHub 問題](https://github.com/dotnet/aspnetcore/issues/24987)。</span><span class="sxs-lookup"><span data-stu-id="15227-273">For more information, see [this GitHub issue](https://github.com/dotnet/aspnetcore/issues/24987).</span></span>

## <a name="review-breaking-changes"></a><span data-ttu-id="15227-274">檢查重大變更</span><span class="sxs-lookup"><span data-stu-id="15227-274">Review breaking changes</span></span>

<span data-ttu-id="15227-275">如需從 .NET Core 3.1 到 .NET 5.0 的重大變更，請參閱 [從版本3.1 遷移至5.0 的重大變更](/dotnet/core/compatibility/3.1-5.0)。</span><span class="sxs-lookup"><span data-stu-id="15227-275">For breaking changes from .NET Core 3.1 to .NET 5.0, see [Breaking changes for migration from version 3.1 to 5.0](/dotnet/core/compatibility/3.1-5.0).</span></span> <span data-ttu-id="15227-276">清單中也包含 ASP.NET Core 和 Entity Framework Core。</span><span class="sxs-lookup"><span data-stu-id="15227-276">ASP.NET Core and Entity Framework Core are also included in the list.</span></span>
